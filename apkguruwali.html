<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portal Guru Wali ‚Äì SMPN 8 Cikarang Utara</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Fredoka+One&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
  <link rel="icon" type="image/jpeg" href="https://i.imgur.com/mRmw86t.jpeg">
  <style>
    .font-nunito { font-family: 'Nunito', sans-serif; }
    .font-fredoka { font-family: 'Fredoka One', cursive; }
    .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    .float-animation { animation: float 3s ease-in-out infinite; }
    .tab-active { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white !important; transform: scale(1.05); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
    .scroll-container::-webkit-scrollbar { width: 6px; }
    .scroll-container::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 10px; }
    .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(99, 102, 241, 0.2); backdrop-filter: blur(4px); z-index: 9999; align-items: center; justify-content: center; }
    .btn-tab-list::-webkit-scrollbar { display: none; }
    @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .animate-modal { animation: modalFadeIn 0.2s ease-out forwards; }
  #page-login.hidden {
    display: none !important;
}
  </style>
</head>
<body class="h-full font-nunito text-gray-800">

  <div id="loading" class="loading-overlay">
    <div class="bg-white p-6 rounded-3xl shadow-2xl flex flex-col items-center border-2 border-indigo-100">
      <div class="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
      <p class="mt-3 font-bold text-indigo-600">Sedang Memproses...</p>
    </div>
  </div>

  <div id="app" class="min-h-full w-full bg-gradient-to-br from-[#667eea] via-[#764ba2] to-[#f093fb] flex flex-col">
    
    <div id="page-login" class="fixed inset-0 flex items-center justify-center p-4 z-[100]">
      <div class="max-w-md w-full glass-card rounded-[2.5rem] p-10 shadow-2xl float-animation text-center relative z-10">
        <div class="w-20 h-20 bg-gradient-to-tr from-indigo-500 to-purple-500 rounded-3xl mx-auto mb-4 flex items-center justify-center text-4xl shadow-lg">üè´</div>
        <h1 class="font-fredoka text-3xl text-indigo-600 mb-2">Portal Guru Wali</h1>
        <p class="text-gray-500 font-semibold mb-8 uppercase text-sm tracking-widest">SMP NEGERI 8 CIKARANG UTARA</p>
        
        <div class="space-y-4">
          <div class="relative">
            <input type="text" id="user" class="w-full px-5 py-4 rounded-2xl border-2 border-gray-100 focus:border-indigo-400 outline-none transition-all pl-12" placeholder="Username">
            <span class="absolute left-4 top-4 opacity-30">üë§</span>
          </div>
          <div class="relative">
            <input type="password" id="pass" class="w-full px-5 py-4 rounded-2xl border-2 border-gray-100 focus:border-indigo-400 outline-none transition-all pl-12" placeholder="Password">
            <span class="absolute left-4 top-4 opacity-30">üîë</span>
          </div>
          <button onclick="handleLogin()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-extrabold py-4 rounded-2xl shadow-indigo-200 shadow-lg transition-all active:scale-95 mt-4">LOGIN</button>
          <p id="login-msg" class="text-red-500 text-sm font-bold"></p>
        </div>

        <div class="mt-8 pt-6 border-t border-gray-100">
           <p class="text-gray-400 text-[10px] font-bold tracking-widest uppercase">¬© 2026 SMP NEGERI 8 CIKARANG UTARA</p>
           <p class="text-indigo-400 text-[9px] font-bold mt-1">Algian Manggara, S.Agr</p>
        </div>
      </div>
    </div>

    <div id="page-dashboard" class="hidden min-h-screen flex flex-col">
      <header class="bg-white/90 backdrop-blur-md sticky top-0 z-50 shadow-sm border-b border-indigo-100">
        <div class="max-w-7xl mx-auto px-6 py-4 flex flex-wrap items-center justify-between gap-4">
          <div class="flex items-center gap-4">
            <div class="w-11 h-11 rounded-2xl bg-indigo-600 flex items-center justify-center text-xl shadow-lg">üë®‚Äçüè´</div>
            <div>
              <h2 id="display-nama-guru" class="font-fredoka text-xl text-gray-800 leading-tight">-</h2>
              <p class="text-[10px] text-indigo-500 font-bold uppercase tracking-widest leading-none">Jurnal Guru Wali - SMPN 8 CIKARANG UTARA</p>
            </div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button onclick="openJurnalKelas()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-xl text-xs font-bold transition-all">üìù Jurnal Kelas</button>
            <button onclick="openAddStudentModal()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl text-xs font-bold transition-all">+ Pilih Siswa</button>
            <button onclick="downloadPDF()" class="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-indigo-100">Cetak Laporan</button>
            <button onclick="location.reload()" class="bg-red-50 text-red-500 px-4 py-2 rounded-xl text-xs font-bold hover:bg-red-100">Keluar</button>
          </div>
        </div>
      </header>

      <main class="max-w-7xl mx-auto px-6 py-8 grid lg:grid-cols-12 gap-8 w-full flex-grow">
        <div class="lg:col-span-4">
          <div class="glass-card rounded-[2rem] p-6 shadow-xl sticky top-24">
            <h3 class="font-fredoka text-lg text-gray-700 mb-4 flex items-center gap-2">üìã Siswa Binaan</h3>
            <div id="list-murid-binaan" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2 scroll-container"></div>
          </div>
        </div>

        <div class="lg:col-span-8">
          <div id="form-placeholder" class="glass-card rounded-[2rem] p-12 text-center shadow-xl h-full flex flex-col items-center justify-center">
            <div class="text-7xl mb-4 opacity-20">üëã</div>
            <h3 class="font-fredoka text-2xl text-gray-400">Pilih siswa atau klik Jurnal Kelas.</h3>
          </div>

          <div id="form-container" class="hidden glass-card rounded-[2rem] overflow-hidden shadow-2xl">
            <div id="form-header" class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white flex justify-between items-center">
              <div>
                <h2 id="selected-student-name" class="font-fredoka text-2xl uppercase tracking-wide">-</h2>
                <p id="selected-student-nisn" class="opacity-80 text-xs font-bold tracking-widest">NISN: -</p>
              </div>
              <div id="form-icon" class="text-3xl opacity-30">üë§</div>
            </div>
            
            <div class="p-6">
              <div id="tab-list-individu" class="flex gap-2 mb-8 overflow-x-auto pb-2 btn-tab-list">
                <button onclick="switchTab('Monitoring')" class="px-5 py-2 rounded-xl text-sm font-bold bg-gray-100 text-gray-500 tab-btn whitespace-nowrap" id="btn-Monitoring">Monit.</button>
                <button onclick="switchTab('Observasi')" class="px-5 py-2 rounded-xl text-sm font-bold bg-gray-100 text-gray-500 tab-btn whitespace-nowrap" id="btn-Observasi">Obs.</button>
                <button onclick="switchTab('BK')" class="px-5 py-2 rounded-xl text-sm font-bold bg-gray-100 text-gray-500 tab-btn whitespace-nowrap" id="btn-BK">BK</button>
                <button onclick="switchTab('Prestasi')" class="px-5 py-2 rounded-xl text-sm font-bold bg-gray-100 text-gray-500 tab-btn whitespace-nowrap" id="btn-Prestasi">Prestasi</button>
                <button onclick="switchTab('Notulen')" class="px-5 py-2 rounded-xl text-sm font-bold bg-gray-100 text-gray-500 tab-btn whitespace-nowrap" id="btn-Notulen">O/W</button>
                <button onclick="switchTab('RTL')" class="px-5 py-2 rounded-xl text-sm font-bold bg-gray-100 text-gray-500 tab-btn whitespace-nowrap" id="btn-RTL">RTL</button>
              </div>

              <form id="mainForm" class="space-y-4">
                <input type="hidden" id="in-nisn">
                <input type="hidden" id="in-jenisForm" value="Monitoring">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-[10px] font-black text-indigo-500 uppercase ml-2 mb-1">Pilih Tanggal</label>
                        <input type="date" id="in-tanggal" class="w-full px-5 py-3 rounded-2xl border-2 border-gray-100 outline-none focus:border-indigo-400">
                    </div>
                </div>
                <div id="dynamic-inputs" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                <button type="button" onclick="saveData()" class="w-full mt-6 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-black py-4 rounded-2xl shadow-xl hover:opacity-90 active:scale-[0.98] transition-all">SIMPAN DATA</button>
              </form>
            </div>
          </div>
        </div>
      </main>

      <footer class="w-full py-6 mt-auto">
        <div class="max-w-7xl mx-auto px-6 text-center">
          <p class="text-white/60 text-[10px] font-bold tracking-[0.2em] uppercase">2026 SMP NEGERI 8 CIKARANG UTARA <span class="mx-2 opacity-30">|</span> <span class="text-white/80">Algian Manggara, S.Agr</span></p>
        </div>
      </footer>
    </div>
  </div>

  <div id="modal-siswa" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
      <div class="bg-white w-full max-w-2xl rounded-[2.5rem] p-8 flex flex-col max-h-[90vh] shadow-2xl">
          <div class="flex justify-between items-center mb-4">
              <h2 class="font-fredoka text-2xl text-indigo-600">Pilih Siswa Binaan</h2>
              <button onclick="closeAddStudentModal()" class="text-gray-400 hover:text-red-500 text-3xl font-bold">&times;</button>
          </div>
          <input type="text" id="search-master" onkeyup="filterMasterSiswa()" placeholder="Cari Nama, Kelas, atau NISN..." class="w-full px-5 py-3 rounded-2xl border-2 border-gray-100 mb-4 outline-none focus:border-indigo-400">
          <div class="overflow-y-auto flex-grow scroll-container border-2 border-gray-50 rounded-2xl p-2" id="master-siswa-list"></div>
          <div class="mt-6 flex gap-3">
              <button onclick="closeAddStudentModal()" class="flex-1 bg-gray-100 py-4 rounded-2xl font-bold text-gray-500">Batal</button>
              <button onclick="saveSelectedStudents()" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold">Simpan Pilihan</button>
          </div>
      </div>
  </div>

  <div id="modal-preview" class="hidden fixed inset-0 flex items-center justify-center p-4" style="z-index: 9999; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px);">
      <div class="bg-white w-full max-w-5xl rounded-[2.5rem] flex flex-col max-h-[90vh] shadow-2xl overflow-hidden animate-modal">
          <div class="p-6 border-b flex justify-between items-center bg-white sticky top-0">
              <div><h2 class="font-fredoka text-2xl text-indigo-600 leading-tight">Riwayat Laporan</h2><p id="preview-student-info" class="text-sm text-gray-400 font-bold mt-1 uppercase"></p></div>
              <button onclick="closePreview()" class="w-10 h-10 flex items-center justify-center rounded-full bg-red-50 text-red-500 text-2xl">&times;</button>
          </div>
          <div class="p-6 overflow-y-auto flex-grow scroll-container bg-gray-50/50">
              <div class="overflow-x-auto rounded-2xl border border-gray-200 bg-white">
                  <table class="w-full text-left border-collapse">
                      <thead class="bg-indigo-600 text-white text-[11px] uppercase">
                          <tr><th class="p-4 border-b">Tanggal</th><th class="p-4 border-b">Kategori</th><th class="p-4 border-b">Kegiatan & Masalah</th><th class="p-4 border-b">Tindakan & Evaluasi</th></tr>
                      </thead>
                      <tbody id="preview-table-body" class="text-gray-700 divide-y divide-gray-100"></tbody>
                  </table>
              </div>
          </div>
          <div class="p-6 border-t bg-white flex justify-end">
              <button onclick="closePreview()" class="bg-indigo-100 text-indigo-600 px-8 py-3 rounded-2xl font-bold">Tutup</button>
          </div>
      </div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxrE83zjEaelSM_8Uza2MPVuVaEBbjJ5sv9RjIqc7S4bAGFmc16_8e1ZBkF2SA9QR8/exec"; 
    let session = { username: "", nama: "" };
    let masterSiswaData = [];

    function toggleLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

    async function callGAS(action, data = {}) {
      const url = `${GAS_URL}?action=${action}`;
      try {
        const response = await fetch(url, { method: "POST", body: JSON.stringify(data) });
        return await response.json();
      } catch (err) { return { status: "error", message: err.toString() }; }
    }

    async function handleLogin() {
      const u = document.getElementById('user').value;
      const p = document.getElementById('pass').value;
      if(!u || !p) return alert("Isi Username dan Password!");
      toggleLoading(true);
      const res = await callGAS("login", { username: u, password: p });
      if(res.status === "success") {
    // Ubah bagian ini agar menyimpan NIP juga
    session = { username: res.username, nama: res.nama, nip: res.nip }; 
    document.getElementById('display-nama-guru').innerText = `Halo, ${res.nama}!`;
    await loadDashboard();
    } else {
        toggleLoading(false);
        document.getElementById('login-msg').innerText = res.message;
      }
    }

    async function loadDashboard() {
      toggleLoading(true);
      const data = await callGAS("getMyStudents", { username: session.username });
      let html = "";
      if(Array.isArray(data) && data.length > 0) {
        data.forEach((s, index) => {
          // Sanitasi nama untuk menghindari error quote dalam fungsi onclick
          const cleanName = s.nama.replace(/'/g, "\\'");
          html += `
            <div class="flex items-center gap-2 group">
                <button onclick="selectStudent('${s.nisn}', '${cleanName}')" class="flex-grow text-left p-4 rounded-2xl bg-white border-2 border-transparent hover:border-indigo-200 hover:bg-indigo-50 transition-all flex items-center gap-3 shadow-sm">
                    <div class="w-10 h-10 rounded-xl bg-indigo-50 group-hover:bg-white flex items-center justify-center text-lg">üë§</div>
                    <div><p class="font-bold text-gray-700 leading-none text-sm">${s.nama}</p><p class="text-[9px] text-gray-400 mt-1 font-bold uppercase tracking-widest">${s.nisn} | ${s.kelas}</p></div>
                </button>
                <button onclick="showPreview('${s.nisn}', '${cleanName}')" class="p-4 bg-white border-2 border-transparent hover:border-indigo-500 text-gray-300 hover:text-indigo-500 rounded-2xl transition-all shadow-sm">üëÅÔ∏è</button>
            </div>`;
        });
      } else { html = `<div class="text-center py-10 opacity-30 text-xs font-bold">Belum ada siswa.</div>`; }
      document.getElementById('list-murid-binaan').innerHTML = html;
      document.getElementById('page-login').classList.add('hidden');
      document.getElementById('page-dashboard').classList.remove('hidden');
      toggleLoading(false);
    }

    function openJurnalKelas() {
        document.getElementById('form-placeholder').classList.add('hidden');
        document.getElementById('form-container').classList.remove('hidden');
        document.getElementById('tab-list-individu').classList.add('hidden');
        document.getElementById('selected-student-name').innerText = "Jurnal Kelas / Pertemuan";
        document.getElementById('selected-student-nisn').innerText = "CATATAN KOLEKTIF GURU";
        document.getElementById('form-header').style.background = "linear-gradient(to right, #9333ea, #a855f7)";
        document.getElementById('form-icon').innerText = "üìö";
        document.getElementById('in-nisn').value = "JURNAL_KELAS";
        document.getElementById('in-jenisForm').value = "Jurnal";
        renderDynamicForm('Jurnal');
    }

    function selectStudent(nisn, nama) {
      document.getElementById('form-placeholder').classList.add('hidden');
      document.getElementById('form-container').classList.remove('hidden');
      document.getElementById('tab-list-individu').classList.remove('hidden');
      document.getElementById('selected-student-name').innerText = nama;
      document.getElementById('selected-student-nisn').innerText = "NISN: " + nisn;
      document.getElementById('form-header').style.background = "linear-gradient(to right, #4f46e5, #7c3aed)";
      document.getElementById('form-icon').innerText = "üë§";
      document.getElementById('in-nisn').value = nisn;
      switchTab('Monitoring');
    }

    function switchTab(type) {
      document.getElementById('in-jenisForm').value = type;
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active'));
      const activeBtn = document.getElementById('btn-' + type);
      if(activeBtn) activeBtn.classList.add('tab-active');
      renderDynamicForm(type);
    }

    function renderDynamicForm(type) {
      const container = document.getElementById('dynamic-inputs');
      let html = "";
      const inputClass = "w-full px-5 py-3 rounded-2xl border-2 border-gray-100 outline-none focus:border-indigo-400 text-sm";

      if (type === 'Jurnal') {
        html = `
          <input type="number" id="in-mingguKe" class="${inputClass}" placeholder="Minggu Ke-">
          <textarea id="in-kegiatan" class="${inputClass} md:col-span-2" placeholder="Topik Bahasan / Agenda Pertemuan"></textarea>
          <textarea id="in-permasalahan" class="${inputClass} md:col-span-2" placeholder="Catatan Kelas / Masalah"></textarea>
          <textarea id="in-tindakLanjut" class="${inputClass} md:col-span-2" placeholder="Kesimpulan"></textarea>`;
      } 
      else if (type === 'Monitoring') {
        html = `<input type="text" id="in-aspekAkad" class="${inputClass}" placeholder="Aspek Akademik"><input type="text" id="in-aspekNon" class="${inputClass}" placeholder="Aspek Non Akademik"><textarea id="in-catatan" class="${inputClass} md:col-span-2" placeholder="Catatan Khusus"></textarea>`;
      } 
      else if (type === 'Observasi') {
        html = `<input type="text" id="in-aspekAkad" class="${inputClass}" placeholder="Aspek yang Diamati"><textarea id="in-permasalahan" class="${inputClass} md:col-span-2" placeholder="Hasil Observasi"></textarea><textarea id="in-catatan" class="${inputClass} md:col-span-2" placeholder="Kesimpulan"></textarea>`;
      } 
      else if (type === 'BK') {
        html = `<textarea id="in-permasalahan" class="${inputClass} md:col-span-2" placeholder="Permasalahan"></textarea><textarea id="in-tindakLanjut" class="${inputClass} md:col-span-2" placeholder="Tindakan BK"></textarea><textarea id="in-evaluasi" class="${inputClass} md:col-span-2" placeholder="Evaluasi"></textarea>`;
      } 
      else if (type === 'Prestasi') {
        html = `<input type="text" id="in-aspekAkad" class="${inputClass}" placeholder="Prestasi Akademik"><input type="text" id="in-aspekNon" class="${inputClass}" placeholder="Prestasi Non Akademik"><input type="number" id="in-mingguKe" class="${inputClass}" placeholder="Total Prestasi"><input type="text" id="in-kegiatan" class="${inputClass}" placeholder="Ketidakhadiran">`;
      }
      else if (type === 'Notulen') {
        html = `<input type="text" id="in-namaWali" class="${inputClass} md:col-span-2" placeholder="Nama Orang Tua / Wali"><textarea id="in-agenda" class="${inputClass} md:col-span-2" placeholder="Agenda dan Kesepakatan"></textarea><textarea id="in-tindakLanjut" class="${inputClass} md:col-span-2" placeholder="Tindak Lanjut"></textarea><textarea id="in-catatan" class="${inputClass} md:col-span-2" placeholder="Keterangan"></textarea>`;
      }
      else if (type === 'RTL') {
        html = `<textarea id="in-permasalahan" class="${inputClass} md:col-span-2" placeholder="Masalah Utama"></textarea><div class="md:col-span-2"><label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">Tanggal Perubahan</label><input type="date" id="in-tglPerubahan" class="${inputClass}"></div><textarea id="in-tindakLanjut" class="${inputClass} md:col-span-2" placeholder="Intervensi"></textarea><textarea id="in-evaluasi" class="${inputClass} md:col-span-2" placeholder="Evaluasi"></textarea>`;
      }
      container.innerHTML = html;
    }

    async function saveData() {
      const payload = {
        username: session.username,
        namaGuru: session.nama, 
        namaSiswa: document.getElementById('selected-student-name').innerText,
        nisn: document.getElementById('in-nisn').value,
        jenisForm: document.getElementById('in-jenisForm').value,
        tanggal: document.getElementById('in-tanggal').value,
        mingguKe: document.getElementById('in-mingguKe')?.value || "",
        kegiatan: document.getElementById('in-kegiatan')?.value || "",
        permasalahan: document.getElementById('in-permasalahan')?.value || "",
        tindakLanjut: document.getElementById('in-tindakLanjut')?.value || "",
        aspekAkad: document.getElementById('in-aspekAkad')?.value || "",
        aspekNon: document.getElementById('in-aspekNon')?.value || "",
        catatan: document.getElementById('in-catatan')?.value || "",
        evaluasi: document.getElementById('in-evaluasi')?.value || "",
        namaWali: document.getElementById('in-namaWali')?.value || "",
        agenda: document.getElementById('in-agenda')?.value || "",
        tglPerubahan: document.getElementById('in-tglPerubahan')?.value || ""
      };
      if(!payload.tanggal) return alert("Pilih tanggal kegiatan!");
      toggleLoading(true);
      const res = await callGAS("submitForm", payload);
      toggleLoading(false);
      if(res.status === "success") { 
          alert("Data berhasil tersimpan!"); 
          document.getElementById('mainForm').reset(); 
          renderDynamicForm(payload.jenisForm); 
      }
    }

    async function downloadPDF() {
    toggleLoading(true);
    const allData = await callGAS("getRawData", { username: session.username });
    if (!allData || allData.length === 0) {
        toggleLoading(false);
        return alert("Data laporan masih kosong.");
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4'); // Landscape A4
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    // Data Konfigurasi Kategori dan Header Tabel
    const categories = [
        { id: "Jurnal", title: "LAPORAN JURNAL KEGIATAN KELAS", headers: [['Minggu', 'Tanggal', 'Topik/Agenda', 'Catatan/Masalah', 'Kesimpulan']] },
        { id: "Monitoring", title: "LAPORAN MONITORING SISWA", headers: [['Siswa', 'Tanggal', 'Aspek Akad', 'Aspek Non', 'Catatan']] },
        { id: "Observasi", title: "LAPORAN OBSERVASI SISWA", headers: [['Siswa', 'Tanggal', 'Aspek Diamati', 'Hasil Observasi', 'Kesimpulan']] },
        { id: "BK", title: "LAPORAN BIMBINGAN KONSELING", headers: [['Siswa', 'Tanggal', 'Permasalahan', 'Tindakan BK', 'Evaluasi']] },
        { id: "Prestasi", title: "LAPORAN PRESTASI & KEHADIRAN", headers: [['Siswa', 'Tanggal', 'Pres. Akad', 'Pres. Non', 'Jml Prestasi', 'Absensi']] },
        { id: "Notulen", title: "LAPORAN PERTEMUAN ORANG TUA / WALI", headers: [['Siswa', 'Tanggal', 'Nama Wali', 'Agenda/Kesepakatan', 'Tindak Lanjut']] },
        { id: "RTL", title: "LAPORAN RENCANA TINDAK LANJUT (RTL)", headers: [['Siswa', 'Tanggal', 'Masalah Utama', 'Intervensi', 'Evaluasi']] }
    ];

    let isFirstPage = true;

    categories.forEach((cat) => {
        // Filter data berdasarkan jenisForm
        const filteredData = allData.filter(d => {
            if (cat.id === "Jurnal") return d.jenisForm === "Jurnal" || String(d.nisn) === "JURNAL_KELAS";
            return d.jenisForm === cat.id;
        });

        // Jika tidak ada data di kategori ini, lewati halaman ini
        if (filteredData.length === 0) return;

        if (!isFirstPage) doc.addPage();
        isFirstPage = false;

        // --- Judul Halaman ---
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text(cat.title, pageWidth / 2, 15, { align: 'center' });
        doc.setFontSize(10);
        doc.text(`SMP NEGERI 8 CIKARANG UTARA`, pageWidth / 2, 20, { align: 'center' });
        doc.line(14, 23, pageWidth - 14, 23); // Garis pemisah

        // --- Tabel Data ---
        doc.autoTable({
            startY: 28,
            head: cat.headers,
            body: filteredData.map(d => {
                if (cat.id === "Jurnal") return [d.mingguKe || '-', d.tanggal, d.kegiatan || '-', d.permasalahan || '-', d.tindakLanjut || '-'];
                if (cat.id === "Monitoring") return [d.namaSiswa, d.tanggal, d.aspekAkad || '-', d.aspekNon || '-', d.catatan || '-'];
                if (cat.id === "Observasi") return [d.namaSiswa, d.tanggal, d.aspekAkad || '-', d.permasalahan || '-', d.catatan || '-'];
                if (cat.id === "BK") return [d.namaSiswa, d.tanggal, d.permasalahan || '-', d.tindakLanjut || '-', d.evaluasi || '-'];
                if (cat.id === "Prestasi") return [d.namaSiswa, d.tanggal, d.aspekAkad || '-', d.aspekNon || '-', d.mingguKe || '-', d.kegiatan || '-'];
                if (cat.id === "Notulen") return [d.namaSiswa, d.tanggal, d.namaWali || '-', d.agenda || '-', d.tindakLanjut || '-'];
                if (cat.id === "RTL") return [d.namaSiswa, d.tanggal, d.permasalahan || '-', d.tindakLanjut || '-', d.evaluasi || '-'];
                return [];
            }),
            theme: 'grid',
            headStyles: { fillColor: [79, 70, 229], halign: 'center' },
            styles: { fontSize: 8, cellPadding: 3 },
            margin: { bottom: 60 } // Ruang untuk tanda tangan
        });

        // --- Bagian Tanda Tangan ---
        const finalY = doc.lastAutoTable.finalY + 15;
        const signatureY = finalY + 25; // Posisi nama setelah ruang tanda tangan

        // Pastikan tanda tangan tidak terpotong ke halaman baru sendirian
        if (signatureY > pageHeight - 20) {
            doc.addPage();
            // Reset Y jika pindah halaman
            var newY = 20; 
        } else {
            var newY = finalY;
        }

        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");

        // Tanggal Laporan (Kanan)
        const today = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
        doc.text(`Cikarang Utara, ${today}`, pageWidth - 70, newY);

        // Sebelah Kiri: Kepala Sekolah
        doc.text("Mengetahui,", 20, newY + 5);
        doc.text("Kepala SMPN 8 Cikarang Utara,", 20, newY + 10);
        doc.setFont("helvetica", "bold");
        doc.text("HASANAH AISAH, M.Pd", 20, newY + 35);
        doc.setFont("helvetica", "normal");
        doc.text("NIP. 1969020319980202005", 20, newY + 40);

        // Sebelah Kanan: Guru Wali (User Aktif)
doc.text("Guru Wali Kelas,", pageWidth - 70, newY + 10);
doc.setFont("helvetica", "bold");
doc.text(session.nama.toUpperCase(), pageWidth - 70, newY + 35);
doc.setFont("helvetica", "normal");

// Mengambil NIP dari session, jika kosong tampilkan garis titik-titik
const nipGuru = session.nip && session.nip !== "-" ? "NIP. " + session.nip : "NIP. ...........................";
doc.text(nipGuru, pageWidth - 70, newY + 40);
    });

    doc.save(`Laporan_Lengkap_${session.nama}_${new Date().getTime()}.pdf`);
    toggleLoading(false);
}

    async function showPreview(nisn, nama) {
      const modal = document.getElementById('modal-preview');
      const tableBody = document.getElementById('preview-table-body');
      modal.classList.remove('hidden');
      document.getElementById('preview-student-info').innerText = "Riwayat: " + nama;
      tableBody.innerHTML = '<tr><td colspan="4" class="p-10 text-center animate-pulse">Mengambil data...</td></tr>';
      
      try {
          const res = await callGAS("getRawData", { username: session.username });
          // Perbaikan filter: Gunakan toString() dan trim() untuk memastikan pencocokan akurat
          const studentData = res.filter(d => 
            String(d.nisn).trim() === String(nisn).trim() && 
            d.jenisForm !== "Jurnal" && 
            String(d.nisn) !== "JURNAL_KELAS"
          );
          
          let html = "";
          if (studentData.length > 0) {
              studentData.forEach(d => {
                  html += `<tr class="border-b text-[11px]"><td class="p-4 font-bold">${d.tanggal}</td><td class="p-4"><span class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded-lg text-[9px] font-black uppercase">${d.jenisForm}</span></td><td class="p-4">${d.permasalahan || d.kegiatan || '-'}</td><td class="p-4">${d.tindakLanjut || d.catatan || '-'}</td></tr>`;
              });
              tableBody.innerHTML = html;
          } else { 
              tableBody.innerHTML = '<tr><td colspan="4" class="p-10 text-center italic text-gray-400">Belum ada catatan individu untuk siswa ini.</td></tr>'; 
          }
      } catch (err) { 
          tableBody.innerHTML = '<tr><td colspan="4" class="p-10 text-center text-red-500 font-bold">Error mengambil data riwayat.</td></tr>'; 
      }
    }

    function closePreview() { document.getElementById('modal-preview').classList.add('hidden'); }
    
    async function openAddStudentModal() { 
        document.getElementById('modal-siswa').classList.remove('hidden'); 
        const res = await callGAS("getMasterSiswa"); 
        masterSiswaData = res; 
        renderMasterSiswa(res); 
    }
    
    function closeAddStudentModal() { document.getElementById('modal-siswa').classList.add('hidden'); }
    
    function renderMasterSiswa(data) {
        let html = "";
        data.forEach(s => { 
            html += `<label class="flex items-center p-4 hover:bg-indigo-50 rounded-2xl cursor-pointer transition-all"><input type="checkbox" name="siswa-ceklis" value="${s.nisn}" class="w-6 h-6 rounded-lg text-indigo-600"><div class="ml-4"><p class="font-bold text-sm">${s.nama}</p><p class="text-[10px] text-gray-400 uppercase tracking-wider">${s.nisn} ‚Äî Kelas ${s.kelas}</p></div></label>`; 
        });
        document.getElementById('master-siswa-list').innerHTML = html || "<p class='text-center py-10'>Data master kosong.</p>";
    }
    
    function filterMasterSiswa() { 
        const q = document.getElementById('search-master').value.toLowerCase(); 
        const filtered = masterSiswaData.filter(s => s.nama.toLowerCase().includes(q) || s.kelas.toLowerCase().includes(q) || String(s.nisn).includes(q) ); 
        renderMasterSiswa(filtered); 
    }
    
    async function saveSelectedStudents() {
        const checkboxes = document.querySelectorAll('input[name="siswa-ceklis"]:checked');
        const selectedNisns = Array.from(checkboxes).map(cb => cb.value);
        if(selectedNisns.length === 0) return alert("Pilih minimal satu siswa!");
        toggleLoading(true);
        const res = await callGAS("saveRelasiBulk", { username: session.username, nisns: selectedNisns });
        if(res.status === "success") { 
            alert("Berhasil memperbarui daftar siswa!"); 
            closeAddStudentModal(); 
            await loadDashboard(); 
        } else { 
            toggleLoading(false); 
            alert("Gagal menyimpan pilihan."); 
        }
    }
  // Tambahkan event listener untuk menekan tombol Enter di form login
document.addEventListener("DOMContentLoaded", function() {
  const loginForm = ["user", "pass"];
  
  loginForm.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
          event.preventDefault(); // Mencegah form submit default jika ada
          handleLogin();
        }
      });
    }
  });
});
  </script>
</body>
</html>
